<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARGUS SPEAK LAB-X ‚Äî Avatar Beta</title>
  <meta name="theme-color" content="#0b1630" />
  <style>
    :root{
      --bg1:#071027;
      --bg2:#0b1630;
      --txt:#eaf2ff;
      --muted:#b7c7e6;
      --stroke:rgba(255,255,255,.10);
      --glow:rgba(88,170,255,.18);
      --ok:#46f2a5;
      --warn:#ffd06a;
      --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 20% 0%, #13386d 0%, transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, #4e2d6b 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 40px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: 0 18px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.02) inset;
      border-radius:26px;
      padding:22px 22px 18px;
      backdrop-filter: blur(8px);
    }
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:10px;}
    h1{
      margin:0;
      font-weight:900;
      letter-spacing:.2px;
      font-size:34px;
      line-height:1.1;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .micIcon{
      width:34px;height:34px;
      display:inline-grid;place-items:center;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow:0 0 22px var(--glow);
    }
    .sub{margin:8px 0 0;color:var(--muted);font-size:15px;line-height:1.4;}
    .pill{
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:13px;white-space:nowrap;
    }

    /* AVATAR */
    .avatarStage{
      margin:14px 0 14px;
      border-radius:26px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background: radial-gradient(900px 420px at 20% 10%, rgba(88,170,255,.20), transparent 55%),
                  radial-gradient(700px 420px at 80% 20%, rgba(70,242,165,.14), transparent 55%),
                  rgba(0,0,0,.20);
      box-shadow: 0 18px 60px rgba(0,0,0,.40), 0 0 0 1px rgba(255,255,255,.02) inset;
      height: 260px;
      position: relative;
    }
    #avatarVideo{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.05);
    }
    .avatarHUD{
      position:absolute;
      left:16px;
      bottom:14px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      max-width: 75%;
    }
    .hudTitle{font-weight:900;letter-spacing:.2px;}
    .hudSub{color:var(--muted);font-size:12px;margin-top:2px;}

    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:12px 0 10px;}
    button, select{
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:12px 14px;
      font-size:16px;
      outline:none;
    }
    button{
      cursor:pointer;
      background:linear-gradient(180deg, rgba(45,130,255,.25), rgba(45,130,255,.10));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .12s ease;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05)); }
    button.danger{ background: linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.10)); }

    .recBtn{
      min-width:300px;
      display:flex;align-items:center;gap:12px;justify-content:center;
      font-weight:800;letter-spacing:.2px;
    }
    .dot{
      width:12px;height:12px;border-radius:99px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .dot.on{
      background: var(--ok);
      box-shadow: 0 0 0 6px rgba(70,242,165,.15), 0 0 18px rgba(70,242,165,.35);
    }

    .vuWrap{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border:1px solid var(--stroke);
      border-radius:16px;background:rgba(0,0,0,.15);
      min-width:240px;
    }
    .vu{height:10px;flex:1;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.06);}
    .vu > div{
      height:100%;width:0%;
      background: linear-gradient(90deg, rgba(70,242,165,.95), rgba(88,170,255,.95));
      box-shadow: 0 0 18px rgba(88,170,255,.25);
      transition: width .06s linear;
    }
    .label{font-size:13px;color:var(--muted);}
    .status{margin:10px 0 12px;color:var(--muted);font-weight:700;}
    .logTitle{margin:10px 0 10px;font-size:24px;font-weight:900;}
    .log{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:18px;
      min-height:260px;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:14px;
      overflow:auto;
    }
    .tagSYS{ color:#b9d4ff; font-weight:900;}
    .tagYOU{ color:var(--warn); font-weight:900;}
    .tagBOT{ color:var(--ok); font-weight:900;}
    .tagERR{ color:var(--err); font-weight:900;}
    .spacer{flex:1;}
    .small{font-size:12px;color:var(--muted);opacity:.9;margin-top:10px;}

    @media (max-width:720px){
      h1{font-size:28px;}
      .recBtn{min-width:100%;}
      .vuWrap{width:100%;}
      select{width:100%;}
      .avatarStage{height:220px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="top">
        <div>
          <h1><span class="micIcon">üéôÔ∏è</span> Avatar Beta (Voz ‚Üí IA ‚Üí Voz)</h1>
          <div class="sub">
            Toca el bot√≥n para grabar. Se detiene con el mismo bot√≥n o por silencio (~0.7s).<br>
            Si la barra ‚ÄúNivel‚Äù no se mueve: cambia el mic en el selector y usa ‚ÄúProbar mic‚Äù.
          </div>
        </div>
        <div class="pill">API: STT function | CHAT function | TTS function</div>
      </div>

      <!-- AVATAR STAGE -->
      <div class="avatarStage">
        <video id="avatarVideo" autoplay loop muted playsinline></video>
        <div class="avatarHUD">
          <div class="hudTitle">ARGUS Avatar</div>
          <div class="hudSub" id="avatarHint">Cargando avatar‚Ä¶</div>
        </div>
      </div>

      <div class="row">
        <button class="recBtn" id="btnTalk">
          <span class="dot" id="dot"></span>
          <span id="btnTalkTxt">Grabar‚Ä¶ (toca para hablar)</span>
        </button>

        <div class="vuWrap" title="Nivel de audio">
          <div class="vu"><div id="vuFill"></div></div>
          <div class="label">Nivel</div>
        </div>

        <div class="spacer"></div>

        <select id="modeSel" title="Modo">
          <option value="coach">Coach</option>
          <option value="grammar">Grammar</option>
          <option value="conversation">Conversation</option>
        </select>

        <select id="micSel" title="Micr√≥fono"></select>

        <button id="btnMicTest" class="secondary">Probar mic</button>
        <button id="btnText" class="secondary">Probar Chat (texto)</button>
        <button id="btnClear" class="secondary">Limpiar</button>
        <button id="btnWipe" class="danger">Borrar memoria</button>
      </div>

      <div class="status">Estado: <span id="statusTxt">idle</span></div>

      <div class="logTitle">Log</div>
      <div class="log" id="logBox"></div>

      <div class="small">
        Tip: Si el avatar no se ve, revisa que exista <b>/assets/avatar.mp4</b> (Network no debe marcar 404).
      </div>
    </div>
  </div>

  <!-- Pipeline primero -->
  <script src="./voicePipeline.js?v=1"></script>
  <!-- Recorder despu√©s -->
  <script src="./voiceRecorder.js?v=1"></script>

  <script>
    // ===== UI hooks usados por recorder/pipeline =====
    const logBox = document.getElementById("logBox");
    const statusTxt = document.getElementById("statusTxt");
    const btnTalk = document.getElementById("btnTalk");
    const btnTalkTxt = document.getElementById("btnTalkTxt");
    const dot = document.getElementById("dot");
    const vuFill = document.getElementById("vuFill");

    const modeSel = document.getElementById("modeSel");
    const micSel = document.getElementById("micSel");
    const btnMicTest = document.getElementById("btnMicTest");
    const btnText = document.getElementById("btnText");
    const btnClear = document.getElementById("btnClear");
    const btnWipe = document.getElementById("btnWipe");

    const avatarVideo = document.getElementById("avatarVideo");
    const avatarHint = document.getElementById("avatarHint");

    window.__voiceLog = (who, msg) => {
      const tag = who || "SYS";
      const cls = tag === "SYS" ? "tagSYS" : tag === "YOU" ? "tagYOU" : tag === "BOT" ? "tagBOT" : "tagERR";
      const line = `<span class="${cls}">${tag}:</span> ${escapeHtml(String(msg || ""))}\n`;
      logBox.innerHTML += line;
      logBox.scrollTop = logBox.scrollHeight;
    };

    window.__voiceState = (s) => {
      statusTxt.textContent = s || "idle";
      if (s === "listening") {
        dot.classList.add("on");
        btnTalkTxt.textContent = "Grabando‚Ä¶ (toca para detener)";
        if (avatarHint) avatarHint.textContent = "Escuchando‚Ä¶";
      } else if (s === "thinking") {
        dot.classList.remove("on");
        btnTalkTxt.textContent = "Procesando‚Ä¶";
        if (avatarHint) avatarHint.textContent = "Pensando‚Ä¶";
      } else if (s === "speaking") {
        dot.classList.remove("on");
        btnTalkTxt.textContent = "Hablando‚Ä¶";
        if (avatarHint) avatarHint.textContent = "Hablando‚Ä¶";
      } else if (s === "error") {
        dot.classList.remove("on");
        btnTalkTxt.textContent = "Error. Reintenta.";
        if (avatarHint) avatarHint.textContent = "Ups‚Ä¶ error.";
      } else {
        dot.classList.remove("on");
        btnTalkTxt.textContent = "Grabar‚Ä¶ (toca para hablar)";
        if (avatarHint) avatarHint.textContent = "Listo.";
      }
    };

    window.__voiceVU = (v) => {
      const pct = Math.max(0, Math.min(1, v || 0)) * 100;
      vuFill.style.width = pct.toFixed(1) + "%";
    };

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ===== Avatar load =====
    if (avatarVideo) {
      avatarVideo.src = "./assets/avatar.mp4";
      avatarVideo.addEventListener("loadeddata", () => {
        window.__voiceLog("SYS", "‚úÖ Avatar cargado.");
        if (avatarHint) avatarHint.textContent = "Listo.";
      });
      avatarVideo.addEventListener("error", () => {
        window.__voiceLog("SYS", "‚ùå No carg√≥ /assets/avatar.mp4 (revisa ruta/archivo).");
        if (avatarHint) avatarHint.textContent = "Falta avatar.mp4";
      });
    }

    // ===== Mic selector support =====
    window.VX_selectedMicId = "";

    async function loadMics(){
      try{
        await navigator.mediaDevices.getUserMedia({audio:true});
        const devices = await navigator.mediaDevices.enumerateDevices();
        const mics = devices.filter(d => d.kind === "audioinput");

        micSel.innerHTML = "";
        for(const d of mics){
          const opt = document.createElement("option");
          opt.value = d.deviceId;
          opt.textContent = d.label || ("Mic " + d.deviceId.slice(0,6));
          micSel.appendChild(opt);
        }

        window.VX_selectedMicId = micSel.value || "";
        window.__voiceLog("SYS", `Mics: ${mics.length}. Seleccionado: ${micSel.options[micSel.selectedIndex]?.textContent || "?"}`);
      }catch(e){
        console.error(e);
        alert("No pude listar mics. Revisa permisos del navegador.");
      }
    }

    micSel.addEventListener("change", () => {
      window.VX_selectedMicId = micSel.value || "";
      window.__voiceLog("SYS", `Mic: ${micSel.options[micSel.selectedIndex]?.textContent || "?"}`);
    });

    // ===== Mode hook (pipeline lo puede usar) =====
    window.VX_mode = modeSel.value;
    modeSel.addEventListener("change", () => {
      window.VX_mode = modeSel.value;
      window.__voiceLog("SYS", "Modo: " + window.VX_mode);
    });

    // ===== Buttons =====
    btnTalk.addEventListener("click", async () => {
      try{
        if (typeof window.VX_toggleTalk !== "function") {
          alert("VX_toggleTalk no est√° listo. Revisa voiceRecorder.js");
          return;
        }
        await window.VX_toggleTalk();
      }catch(e){
        console.error(e);
        alert("Fall√≥ hablar: " + (e?.message || e));
      }
    });

    btnMicTest.addEventListener("click", async () => {
      try{
        if (typeof window.VX_runMicTest !== "function") {
          alert("VX_runMicTest no est√° listo. Revisa voiceRecorder.js");
          return;
        }
        await window.VX_runMicTest(2500);
      }catch(e){
        console.error(e);
        alert("Mic test fall√≥: " + (e?.message || e));
      }
    });

    btnText.addEventListener("click", async () => {
      try{
        const sample = prompt("Escribe algo en ingl√©s para probar CHAT:", "I didn't have time yesterday.");
        if (!sample) return;

        window.__voiceLog("YOU", sample);

        if (typeof window.VX_chatReply !== "function") {
          alert("VX_chatReply no est√° listo. Revisa voicePipeline.js");
          return;
        }

        window.__voiceState("thinking");
        const reply = await window.VX_chatReply(sample);
        window.__voiceLog("BOT", reply || "(sin respuesta)");

        if (window.VX_ttsAudio && window.VX_playAudio && reply) {
          window.__voiceLog("SYS", "TTS‚Ä¶");
          window.__voiceState("speaking");
          const buf = await window.VX_ttsAudio(reply);
          await window.VX_playAudio(buf);
        }

        window.__voiceState("idle");
      }catch(e){
        console.error(e);
        window.__voiceState("error");
        alert("Fall√≥ chat: " + (e?.message || e));
        window.__voiceState("idle");
      }
    });

    btnClear.addEventListener("click", () => {
      logBox.innerHTML = "";
      window.__voiceVU(0);
      window.__voiceState("idle");
    });

    btnWipe.addEventListener("click", () => {
      try{
        localStorage.removeItem("VX_memory");
        localStorage.removeItem("VX_chat_history");
      }catch{}
      window.__voiceLog("SYS", "Memoria local borrada.");
    });

    // Init
    window.__voiceState("idle");
    loadMics();
  </script>
</body>
</html>





