<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARGUS Avatar Beta (Call Mode PRO)</title>
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#07152b; --txt:#e9f2ff; --muted:#9db6d6;
      --card:rgba(255,255,255,.04); --line:rgba(255,255,255,.10);
      --ring: rgba(46,229,157,.25);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{margin:0;background:radial-gradient(900px 500px at 30% 0%, #0e2a55, var(--bg)); color:var(--txt);}
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px;}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:22px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.35);}
    .top{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:32px}
    .sub{margin-top:6px;color:var(--muted)}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:999px;color:var(--muted)}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:16px;margin-top:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button, select{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      color:var(--txt); border-radius:14px; padding:12px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.22); outline:none;
      user-select:none; -webkit-user-select:none;
    }
    button:hover{box-shadow:0 0 0 6px var(--ring), 0 10px 30px rgba(0,0,0,.22);}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btnRec{min-width:370px;display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:#2ee59d;box-shadow:0 0 0 8px rgba(46,229,157,.15)}
    .dot.off{background:rgba(255,255,255,.28);box-shadow:none}
    .dot.red{background:#ff5a7a; box-shadow:0 0 0 8px rgba(255,90,122,.18)}
    .barWrap{display:flex;align-items:center;gap:10px}
    .meter{width:240px;height:12px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .meter > div{height:100%;width:0%;}
    .lbl{font-size:13px;color:var(--muted)}
    .log{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; min-height:190px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .avatarBox{position:relative;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10); background:#000;}
    video{display:block;width:100%;height:auto;background:#000}
    .tag{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:14px;color:var(--txt);backdrop-filter: blur(6px)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .bad{color:#ff6b86}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div>
          <h1>üìû Avatar Beta (Call Mode PRO)</h1>
          <div class="sub">Start = entra en modo llamada. Hablas, la IA responde y vuelve a escucharte sola. Stop = corta todo. (Keep-Alive activado).</div>
        </div>
        <div class="pill">STT ‚Üí CHAT ‚Üí TTS ‚Üí LOOP</div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="avatarBox">
            <video id="avatarVideo" playsinline muted loop preload="auto">
              <source src="./assets/avatar.mp4" type="video/mp4">
            </video>
            <div class="tag" id="avatarTag">ARGUS Avatar</div>
          </div>
          <div class="hr"></div>
          <div class="lbl" id="avatarHint">
            Si ves <span class="bad">Falta avatar.mp4</span>, sube <b>assets/avatar.mp4</b> a la rama beta.
          </div>
        </div>

        <div class="card">
          <div class="row">
            <button id="btnCall" class="btnRec" title="Iniciar/Detener llamada">
              <span class="dot off" id="callDot"></span>
              <span id="callText">Iniciar llamada</span>
            </button>

            <select id="mode">
              <option value="coach">Coach</option>
              <option value="friendly">Friendly</option>
              <option value="strict">Strict</option>
            </select>

            <select id="micSelect" title="Micr√≥fono"></select>

            <button id="btnTest">Probar Chat (texto)</button>
            <button id="btnClear">Limpiar</button>

            <div class="barWrap">
              <div class="meter" title="Nivel de audio"><div id="meterFill"></div></div>
              <div class="lbl">Nivel de audio</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>Estado: <b id="state">idle</b></div>
            <div class="lbl" id="hint"></div>
          </div>

          <div class="hr"></div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- pipeline primero, recorder despu√©s -->
  <script src="./voicePipeline.js?v=30"></script>
  <script src="./voiceRecorder.js?v=30"></script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const logEl = $("log");
    const stateEl = $("state");
    const hintEl = $("hint");
    const btnCall = $("btnCall");
    const callText = $("callText");
    const callDot = $("callDot");
    const meterFill = $("meterFill");
    const modeSel = $("mode");
    const micSel = $("micSelect");
    const vid = $("avatarVideo");
    const avatarHint = $("avatarHint");

    function addLog(line){
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setState(s, note=""){ stateEl.textContent = s; hintEl.textContent = note; }
    function setMeter(v){
      const pct = Math.max(0, Math.min(1, v))*100;
      meterFill.style.width = pct.toFixed(0)+"%";
      meterFill.style.background = pct>8 ? "rgba(46,229,157,.9)" : "rgba(255,255,255,.35)";
    }
    function setCallUI(active){
      callDot.classList.toggle("off", !active);
      callDot.classList.toggle("red", active);
      callText.textContent = active ? "Detener llamada" : "Iniciar llamada";
    }

    // Avatar autoplay attempt
    (async ()=>{
      try{ await vid.play(); }catch(e){}
      vid.addEventListener("error", ()=>{
        avatarHint.innerHTML = `<span class="bad">‚ùå Falta ./assets/avatar.mp4</span> ‚Äî s√∫belo a la rama beta (ruta exacta).`;
      });
    })();

    // Meter hook (lo llama voiceRecorder.js)
    window.VX_onMeter = (v)=>setMeter(v);

    // Mic list
    async function refreshMics(){
      micSel.innerHTML = "";
      try{
        const mics = await window.VX_listMics();
        for(const m of mics){
          const opt = document.createElement("option");
          opt.value = m.deviceId;
          opt.textContent = m.label || `Mic (${m.deviceId.slice(0,6)}‚Ä¶)`;
          micSel.appendChild(opt);
        }
        const saved = localStorage.getItem("VX_MIC");
        if(saved){ micSel.value = saved; }
      }catch(e){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No mic (permiso pendiente)";
        micSel.appendChild(opt);
      }
    }
    micSel.onchange = ()=>{
      localStorage.setItem("VX_MIC", micSel.value);
      if(window.VX_setMic) window.VX_setMic(micSel.value);
    };

    // Test / Clear
    $("btnTest").onclick = async ()=>{
      setState("thinking","Probando chat‚Ä¶");
      addLog("SYS: CHAT (test)‚Ä¶");
      try{
        const reply = await window.VX_chatReply("Hello, test.");
        addLog("BOT: " + reply);
        addLog("SYS: TTS‚Ä¶");
        const audioBuf = await window.VX_ttsAudio(reply);
        await window.VX_playAudio(audioBuf);
        setState("idle","OK");
      }catch(err){
        setState("error","Revisa consola");
        addLog("SYS: ERROR: " + (err?.message || String(err)));
        alert("Fall√≥ voz/IA. Revisa consola.");
      }
    };
    $("btnClear").onclick = ()=>{ logEl.textContent=""; setState("idle",""); };

    // =========================================================
    // CALL MODE PRO (Conversaci√≥n continua + KeepAlive)
    // - Start: activa keep-alive y entra al loop
    // - Cada turno: escucha autostop -> responde -> vuelve a escuchar
    // - Stop: apaga keep-alive + corta loop + fuerza stop si est√° escuchando
    // =========================================================
    let callActive = false;
    let callLoopBusy = false;

    function isListening(){
      return (stateEl.textContent || "").toLowerCase() === "listening";
    }

    async function callLoop(){
      if(callLoopBusy) return;
      callLoopBusy = true;

      try{
        while(callActive){
          await window.VX_startAutoTalk({
            mode: modeSel.value,
            onLog: addLog,
            onState: (s)=>{
              const ss = (s||"").toLowerCase();
              if(ss === "listening") setState("listening","Habla‚Ä¶ (silencio = stop). Click para colgar.");
              else if(ss === "thinking") setState("thinking","Procesando‚Ä¶");
              else if(ss === "idle") setState("idle","Siguiente turno‚Ä¶");
              else if(ss === "error") setState("error","Revisa consola");
              else setState(s,"");
            }
          });

          if(!callActive) break;

          // Pausa m√≠nima entre turnos para estabilidad
          await new Promise(r=>setTimeout(r, 150));

          // Mant√©n vivo el video del avatar
          try{ await vid.play(); }catch(e){}
        }
      }catch(e){
        console.error(e);
        addLog("SYS: ERROR LOOP: " + (e?.message || String(e)));
        setState("error","Revisa consola");
      }finally{
        callLoopBusy = false;
        if(!callActive){
          setState("idle","Llamada detenida");
          setCallUI(false);
        }
      }
    }

    function startCall(){
      callActive = true;
      setCallUI(true);
      addLog("SYS: üìû Llamada iniciada.");
      setState("listening","Habla‚Ä¶ (silencio = stop). Click para colgar.");

      // ‚úÖ KeepAlive ON (clave para que no muera el 2do turno)
      window.VX_setCallKeepAlive?.(true);

      callLoop();
    }

    function stopCall(){
      callActive = false;

      // Forzar stop si justo est√° escuchando
      try{ if(isListening()) window.VX_forceStop?.(); }catch(e){}

      // ‚úÖ KeepAlive OFF
      window.VX_setCallKeepAlive?.(false);

      setCallUI(false);
      addLog("SYS: üì¥ Llamada detenida.");
      setState("idle","Llamada detenida");
    }

    btnCall.onclick = ()=>{
      if(!callActive) startCall();
      else stopCall();
    };

    // Init
    (async ()=>{
      try{
        await refreshMics();
        const saved = localStorage.getItem("VX_MIC");
        if(saved && window.VX_setMic) window.VX_setMic(saved);
      }catch(e){
        addLog("SYS: Aviso: micr√≥fonos no listos (permiso).");
      }
      setCallUI(false);
    })();
  </script>
</body>
</html>









