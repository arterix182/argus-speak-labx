<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARGUS Avatar (Voz ‚Üí IA ‚Üí Voz)</title>
  <style>
    :root{
      --bg:#07152b; --card:#0b2344; --card2:#0a1c36; --txt:#e9f2ff; --muted:#9db6d6;
      --btn:#143d7a; --btn2:#0f2f5e; --ok:#2ee59d; --warn:#ffcc66; --bad:#ff5a7a;
      --ring: rgba(46,229,157,.25);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{margin:0;background:radial-gradient(900px 500px at 30% 0%, #0e2a55, var(--bg)); color:var(--txt);}
    .wrap{max-width:1100px;margin:30px auto;padding:0 16px;}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:22px; padding:22px; box-shadow:0 20px 60px rgba(0,0,0,.35);}
    .top{display:flex;gap:18px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .title{display:flex;gap:12px;align-items:center;}
    .mic{font-size:28px}
    h1{font-size:34px;margin:0;letter-spacing:.3px}
    .sub{color:var(--muted);margin-top:4px}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:999px;color:var(--muted)}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:18px;margin-top:18px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button, select, input{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      color:var(--txt); border-radius:14px; padding:14px 16px; font-weight:650; cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.22); outline:none;
    }
    button:hover{box-shadow:0 0 0 6px var(--ring), 0 10px 30px rgba(0,0,0,.22);}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btnRec{min-width:310px; display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 8px rgba(46,229,157,.15)}
    .dot.off{background:rgba(255,255,255,.28);box-shadow:none}
    .barWrap{display:flex;align-items:center;gap:10px}
    .meter{width:240px;height:12px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .meter > div{height:100%;width:0%;}
    .lbl{font-size:13px;color:var(--muted)}
    .status{font-weight:800}
    .log{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; min-height:190px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .avatarBox{position:relative;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10); background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.35));}
    video{display:block;width:100%;height:auto;background:#000}
    .avatarTag{position:absolute;left:14px;bottom:14px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:14px;color:var(--txt);backdrop-filter: blur(6px)}
    .warn{color:var(--warn)} .bad{color:var(--bad)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div>
          <div class="title">
            <div class="mic">üéôÔ∏è</div>
            <div>
              <h1>ARGUS Avatar (Voz ‚Üí IA ‚Üí Voz)</h1>
              <div class="sub">Toca para grabar. Toca otra vez para detener. (M√°s confiable que ‚Äúauto-silencio‚Äù en el mundo real.)</div>
            </div>
          </div>
        </div>
        <div class="pill" id="apiPill">API: STT | CHAT | TTS</div>
      </div>

      <div class="grid">
        <!-- LEFT: Avatar -->
        <div class="card">
          <div class="avatarBox">
            <video id="avatarVideo" playsinline muted loop preload="auto">
              <source src="assets/avatar.mp4" type="video/mp4"/>
            </video>
            <div class="avatarTag" id="avatarTag">ARGUS Avatar</div>
          </div>
          <div class="hr"></div>
          <div class="lbl" id="avatarHint">
            Si aparece ‚ÄúFalta avatar.mp4‚Äù, revisa que exista <b>assets/avatar.mp4</b> en tu repo y que se haya deployeado.
          </div>
        </div>

        <!-- RIGHT: Controls + Log -->
        <div class="card">
          <div class="row">
            <button id="btnRecord" class="btnRec"><span class="dot off" id="recDot"></span><span id="btnText">Grabar (toca para iniciar)</span></button>

            <select id="mode">
              <option value="coach">Coach</option>
              <option value="friendly">Friendly</option>
              <option value="strict">Strict</option>
            </select>

            <button id="btnTest">Probar Chat (texto)</button>
            <button id="btnClear">Limpiar</button>
            <button id="btnForget">Borrar memoria</button>

            <div class="barWrap">
              <div class="meter" title="Nivel de audio"><div id="meterFill"></div></div>
              <div class="lbl">Nivel de audio</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>Estado: <span class="status" id="state">idle</span></div>
            <div class="lbl" id="hint"></div>
          </div>

          <div class="hr"></div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="voicePipeline.js?v=1"></script>
  <script src="voiceRecorder.js?v=1"></script>
  <script>
    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const logEl = $("log");
    const stateEl = $("state");
    const hintEl = $("hint");
    const btn = $("btnRecord");
    const btnText = $("btnText");
    const recDot = $("recDot");
    const meterFill = $("meterFill");
    const modeSel = $("mode");
    const vid = $("avatarVideo");
    const avatarHint = $("avatarHint");

    function addLog(line){
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setState(s, note=""){
      stateEl.textContent = s;
      hintEl.textContent = note;
    }
    function setRec(on){
      recDot.classList.toggle("off", !on);
      btnText.textContent = on ? "Grabando‚Ä¶ (toca para detener)" : "Grabar (toca para iniciar)";
    }
    function setMeter(v){ // 0..1
      const pct = Math.max(0, Math.min(1, v)) * 100;
      meterFill.style.width = pct.toFixed(0) + "%";
      meterFill.style.background = pct>8 ? "rgba(46,229,157,.9)" : "rgba(255,255,255,.35)";
    }

    // Avatar: autoplay safe attempt
    (async ()=>{
      try{
        await vid.play(); // muted loop should autoplay
      }catch(e){
        // Some browsers block; it's fine. We'll play on first user gesture.
      }
      vid.addEventListener("error", ()=>{
        avatarHint.innerHTML = `<span class="bad">‚ùå Falta avatar.mp4</span> ‚Äî aseg√∫rate de tener <b>assets/avatar.mp4</b> en la rama beta y que Netlify ya hizo deploy.`;
      });
    })();

    // Bridge: voiceRecorder.js expects these globals:
    // window.VX_transcribeAudio, window.VX_chatReply, window.VX_ttsAudio, window.VX_playAudio
    // (Los define voicePipeline.js)

    // Recorder controller
    let isRecording = false;

    $("btnTest").onclick = async ()=>{
      setState("thinking","Probando chat‚Ä¶");
      addLog("SYS: CHAT (test)‚Ä¶");
      try{
        const reply = await window.VX_chatReply("Hello, test.");
        addLog("BOT: " + reply);
        addLog("SYS: TTS‚Ä¶");
        const audioBuf = await window.VX_ttsAudio(reply);
        await window.VX_playAudio(audioBuf);
        setState("idle","OK");
      }catch(err){
        setState("error","Revisa consola");
        addLog("SYS: ERROR: " + (err?.message || String(err)));
        alert("Fall√≥ voz/IA. Revisa consola.");
      }
    };

    $("btnClear").onclick = ()=>{ logEl.textContent=""; setState("idle",""); };
    $("btnForget").onclick = ()=>{ localStorage.removeItem("ARGUS_MEM"); addLog("SYS: Memoria borrada."); };

    // Audio meter from recorder (voiceRecorder.js will call window.VX_onMeter)
    window.VX_onMeter = (v)=>{ setMeter(v); };

    // Start/Stop recording (push-to-talk toggle)
    btn.onclick = async ()=>{
      try{
        if(!isRecording){
          isRecording = true; setRec(true);
          setState("listening","Hablando‚Ä¶ toca otra vez para detener");
          addLog("SYS: Escuchando‚Ä¶");
          await window.VX_startRecording();
        }else{
          isRecording = false; setRec(false);
          setState("thinking","Procesando STT ‚Üí IA ‚Üí TTS");
          await window.VX_stopRecordingAndRun({
            mode: modeSel.value,
            onLog: addLog,
            onState: (s)=>setState(s)
          });
          setState("idle","Listo");
          // Play avatar on user gesture
          try{ await vid.play(); }catch(e){}
        }
      }catch(err){
        isRecording = false; setRec(false);
        setState("error","Revisa consola");
        addLog("SYS: ERROR: " + (err?.message || String(err)));
        alert("Fall√≥ voz/IA: " + (err?.message || String(err)));
      }
    };
  </script>
</body>
</html>






